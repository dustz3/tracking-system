<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airtable API ç¶²é </title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .api-config {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .data-display {
            margin-top: 30px;
        }
        .record {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background-color: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            color: #0c5460;
            background-color: #d1ecf1;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .debug-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .help-section {
            background-color: #e7f3ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .help-section h3 {
            margin-top: 0;
            color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Airtable API ç¶²é </h1>
        
        <div class="help-section">
            <h3>ğŸ”§ æ•…éšœæ’é™¤æŒ‡å—</h3>
            <p><strong>403 éŒ¯èª¤è§£æ±ºæ–¹æ³•ï¼š</strong></p>
            <ol>
                <li>ç¢ºèª API Key æ˜¯å¦æ­£ç¢ºï¼ˆå¾ Airtable â†’ Account â†’ API ç²å–ï¼‰</li>
                <li>ç¢ºèª Base ID æ˜¯å¦æ­£ç¢ºï¼ˆå¾ Airtable ç¶²å€ä¸­è¤‡è£½ï¼‰</li>
                <li>ç¢ºèªè¡¨æ ¼åç¨±æ˜¯å¦æ­£ç¢ºï¼ˆä½¿ç”¨è¡¨æ ¼çš„å¯¦éš›åç¨±ï¼‰</li>
                <li>ç¢ºèªæ‚¨çš„ Airtable å¸³æˆ¶æœ‰æ¬Šé™è¨ªå•è©² Base</li>
            </ol>
        </div>
        
        <div class="api-config">
            <h3>API è¨­å®š</h3>
            <div class="form-group">
                <label for="apiKey">Airtable API Key:</label>
                <input type="password" id="apiKey" placeholder="è¼¸å…¥æ‚¨çš„ Airtable API Key">
            </div>
            <div class="form-group">
                <label for="baseId">Base ID:</label>
                <input type="text" id="baseId" placeholder="è¼¸å…¥æ‚¨çš„ Base ID">
            </div>
            <div class="form-group">
                <label for="tableName">Table Name:</label>
                <input type="text" id="tableName" placeholder="è¼¸å…¥è¡¨æ ¼åç¨±">
            </div>
            <button onclick="testConnection()">æ¸¬è©¦é€£æ¥</button>
            <button onclick="loadData()">è¼‰å…¥æ•¸æ“š</button>
            <button onclick="clearData()">æ¸…é™¤æ•¸æ“š</button>
        </div>

        <div id="message"></div>
        <div id="debugInfo"></div>
        <div id="dataDisplay" class="data-display"></div>
    </div>

    <script>
        // é¡¯ç¤ºè¨Šæ¯å‡½æ•¸
        function showMessage(message, type = 'info') {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }

        // æ¸…é™¤è¨Šæ¯
        function clearMessage() {
            document.getElementById('message').innerHTML = '';
            document.getElementById('debugInfo').innerHTML = '';
        }

        // æ¸¬è©¦ API é€£æ¥
        async function testConnection() {
            const apiKey = document.getElementById('apiKey').value;
            const baseId = document.getElementById('baseId').value;
            const tableName = document.getElementById('tableName').value;

            if (!apiKey || !baseId || !tableName) {
                showMessage('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦çš„ API è³‡è¨Š', 'error');
                return;
            }

            // é©—è­‰ API Key æ ¼å¼
            if (!apiKey.startsWith('pat_') && !apiKey.startsWith('patn')) {
                showMessage('API Key æ ¼å¼éŒ¯èª¤ï¼æ­£ç¢ºçš„ API Key æ‡‰è©²ä»¥ "pat_" æˆ– "patn" é–‹é ­', 'error');
                return;
            }

            if (apiKey.length < 20) {
                showMessage('API Key é•·åº¦ä¸è¶³ï¼è«‹ç¢ºèªæ˜¯å¦å®Œæ•´è¤‡è£½', 'error');
                return;
            }

            clearMessage();
            showMessage('æ­£åœ¨æ¸¬è©¦é€£æ¥...', 'info');

            try {
                // é¦–å…ˆæ¸¬è©¦ Base æ˜¯å¦å¯è¨ªå•
                const baseUrl = `https://api.airtable.com/v0/meta/bases/${baseId}/tables`;
                const baseResponse = await fetch(baseUrl, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                let debugInfo = `<div class="debug-info">
                    <h4>èª¿è©¦è³‡è¨Šï¼š</h4>
                    <p><strong>Base ID:</strong> ${baseId}</p>
                    <p><strong>Table Name:</strong> ${tableName}</p>
                    <p><strong>API Key æ ¼å¼:</strong> ${apiKey.startsWith('pat_') || apiKey.startsWith('patn') ? 'âœ… æ­£ç¢º' : 'âŒ éŒ¯èª¤'}</p>
                    <p><strong>API Key é•·åº¦:</strong> ${apiKey.length} å­—ç¬¦</p>
                    <p><strong>Base æ¸¬è©¦ç‹€æ…‹:</strong> ${baseResponse.status} ${baseResponse.statusText}</p>
                `;

                if (baseResponse.status === 401) {
                    throw new Error('API Key ç„¡æ•ˆï¼è«‹æª¢æŸ¥ï¼š1) API Key æ˜¯å¦æ­£ç¢ºè¤‡è£½ 2) æ˜¯å¦ç‚ºæœ€æ–°çš„ API Key 3) æ˜¯å¦æœ‰æ¬Šé™è¨ªå•è©² Base');
                }

                if (!baseResponse.ok) {
                    throw new Error(`Base æ¸¬è©¦å¤±æ•—: ${baseResponse.status} ${baseResponse.statusText}`);
                }

                const baseData = await baseResponse.json();
                debugInfo += `<p><strong>Base ä¸­çš„è¡¨æ ¼:</strong> ${baseData.tables.map(t => t.name).join(', ')}</p>`;

                // æ¸¬è©¦ç‰¹å®šè¡¨æ ¼
                const tableUrl = `https://api.airtable.com/v0/${baseId}/${encodeURIComponent(tableName)}?maxRecords=1`;
                const tableResponse = await fetch(tableUrl, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                debugInfo += `<p><strong>è¡¨æ ¼æ¸¬è©¦ç‹€æ…‹:</strong> ${tableResponse.status} ${tableResponse.statusText}</p>`;

                if (tableResponse.status === 401) {
                    throw new Error('API Key ç„¡æ•ˆï¼è«‹é‡æ–°ç”Ÿæˆ API Key');
                }

                if (!tableResponse.ok) {
                    throw new Error(`è¡¨æ ¼æ¸¬è©¦å¤±æ•—: ${tableResponse.status} ${tableResponse.statusText}`);
                }

                const tableData = await tableResponse.json();
                debugInfo += `<p><strong>è¡¨æ ¼è¨˜éŒ„æ•¸:</strong> ${tableData.records.length}</p>`;

                document.getElementById('debugInfo').innerHTML = debugInfo;
                showMessage('é€£æ¥æ¸¬è©¦æˆåŠŸï¼API è¨­å®šæ­£ç¢ºã€‚', 'success');

            } catch (error) {
                console.error('Error:', error);
                showMessage(`é€£æ¥æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                
                // æä¾›å…·é«”çš„éŒ¯èª¤å»ºè­°
                let suggestion = '';
                if (error.message.includes('401')) {
                    suggestion = `
                        <strong>401 éŒ¯èª¤è§£æ±ºæ­¥é©Ÿï¼š</strong><br>
                        1. å‰å¾€ Airtable â†’ Account â†’ API<br>
                        2. é»æ“Š "Generate API key" ç”Ÿæˆæ–°çš„ API Key<br>
                        3. å®Œæ•´è¤‡è£½æ–°ç”Ÿæˆçš„ API Keyï¼ˆä»¥ pat_ é–‹é ­ï¼‰<br>
                        4. ç¢ºä¿æ‚¨æœ‰æ¬Šé™è¨ªå•è©² Base
                    `;
                } else if (error.message.includes('403')) {
                    suggestion = 'å»ºè­°æª¢æŸ¥ API Key æ˜¯å¦æ­£ç¢ºï¼Œä»¥åŠæ˜¯å¦æœ‰æ¬Šé™è¨ªå•è©² Baseã€‚';
                } else if (error.message.includes('404')) {
                    suggestion = 'å»ºè­°æª¢æŸ¥ Base ID æˆ–è¡¨æ ¼åç¨±æ˜¯å¦æ­£ç¢ºã€‚';
                }
                
                if (suggestion) {
                    showMessage(suggestion, 'info');
                }
            }
        }

        // è¼‰å…¥ Airtable æ•¸æ“š
        async function loadData() {
            const apiKey = document.getElementById('apiKey').value;
            const baseId = document.getElementById('baseId').value;
            const tableName = document.getElementById('tableName').value;

            if (!apiKey || !baseId || !tableName) {
                showMessage('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦çš„ API è³‡è¨Š', 'error');
                return;
            }

            clearMessage();
            const dataDisplay = document.getElementById('dataDisplay');
            dataDisplay.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';

            try {
                const response = await fetch(`https://api.airtable.com/v0/${baseId}/${encodeURIComponent(tableName)}`, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                displayData(data.records);
                showMessage(`æˆåŠŸè¼‰å…¥ ${data.records.length} ç­†è¨˜éŒ„`, 'success');

            } catch (error) {
                console.error('Error:', error);
                showMessage(`è¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
                dataDisplay.innerHTML = '';
            }
        }

        // é¡¯ç¤ºæ•¸æ“š
        function displayData(records) {
            const dataDisplay = document.getElementById('dataDisplay');
            
            if (records.length === 0) {
                dataDisplay.innerHTML = '<p>æ²’æœ‰æ‰¾åˆ°ä»»ä½•è¨˜éŒ„</p>';
                return;
            }

            let html = '<h3>æ•¸æ“šè¨˜éŒ„</h3>';
            
            records.forEach((record, index) => {
                html += '<div class="record">';
                html += `<h4>è¨˜éŒ„ ${index + 1} (ID: ${record.id})</h4>`;
                
                if (record.fields) {
                    Object.keys(record.fields).forEach(key => {
                        const value = record.fields[key];
                        html += `<p><strong>${key}:</strong> ${value}</p>`;
                    });
                }
                
                html += '</div>';
            });

            dataDisplay.innerHTML = html;
        }

        // æ¸…é™¤æ•¸æ“š
        function clearData() {
            document.getElementById('dataDisplay').innerHTML = '';
            clearMessage();
        }

        // é é¢è¼‰å…¥æ™‚çš„èªªæ˜
        window.onload = function() {
            showMessage('è«‹å…ˆé»æ“Šã€Œæ¸¬è©¦é€£æ¥ã€æŒ‰éˆ•ä¾†é©—è­‰æ‚¨çš„ API è¨­å®šæ˜¯å¦æ­£ç¢º', 'info');
        };
    </script>
</body>
</html> 